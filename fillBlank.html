<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./image/logo1.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/fillblank.css">
    <title>Fill Blank</title>
</head>
<style>
    .choices-container input[type="radio"] {
        opacity: 0;
        position: absolute;
        pointer-events: none;
    }

    #box {
        display: flex;
        justify-content: center;
        color: black;
    }

    .fill-blank-box {
        display: flex;
        gap: 5px;
        margin-left: 20px;
    }

    .fill-blank-box input {
        width: 20px;
        border: none;
        outline: none;
        border-bottom: 2px solid #ff9800;
        color: #ff9800;
        font-size: 20px;
        display: flex;
        justify-content: center;
        text-align: center;
        padding-bottom: 5px;
    }

    #box {
        display: flex;
    }

    .save-word {
        position: absolute;
        z-index: 200;
    }

    .automatic {
        position: absolute;
        top: 30px;
        right: 30px;

    }
</style>

<body>
    <div id="app-container">
        <div class="settings-section" id="settings-container">
            <h2>C√†i ƒë·∫∑t ch·∫ø ƒë·ªô</h2>
            <label>
                <input type="checkbox" name="options" value="random" id="option-random" checked /> Ng·∫´u nhi√™n
            </label>
            <label>
                <input type="checkbox" name="options" value="" id="tudong" checked /> T·ª± ƒë·ªông chuy·ªÉn
            </label>
            <!-- <br /> -->
            <label>
                <input type="checkbox" name="options" value="" id="star-qs" /> Thu·∫≠t ng·ªØ ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u
            </label>
            <!-- <br /> -->
            <label>
                <input type="radio" name="options" value="" id="dinhnghia" checked /> ƒê·ªãnh nghƒ©a
            </label>
            <label>
                <input type="radio" name="options" value="" id="nghe" /> Nghe
            </label>
            <br />
            <label>
                S·ªë l∆∞·ª£ng c√¢u h·ªèi:
                <input type="number" id="question-count" value="5" min="1" />
            </label>
            <button class="action-button" id="start-button" style="display: block; margin: 0 auto; margin-top: 40px;">
                B·∫Øt ƒë·∫ßu
            </button>
        </div>
        <div class="save-word" id="save-word" style="display: none;"><img src="./image/star.png" style="width: 30px;"
                alt=""></div>
        <div class="content-section" id="quiz-container" style="display: none;">

            <h2 class="instructions-text" id="number-qs">question 1</h2>
            <h3 class="display-question" id="meaning">Ti·∫øng Anh</h3>
            <!-- <input type="text" id="user-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi t·∫°i ƒë√¢y..." autocomplete="off" /> -->
            <div id="box"></div>
            <p class="feedback-message" id="feedback-message" style="visibility: hidden;">Th√¥ng b√°o k·∫øt qu·∫£</p>
            <div class="control-buttons">
                <button class="action-button" id="answer-button">ƒê√°p √°n</button>
                <button class="action-button" id="again-button">Nh·∫≠p l·∫°i</button>
                <button class="action-button" id="next-button">Ti·∫øp theo</button>
                <div>
                    <img class="automatic" id="automatic1" src="image/execution (2).png" alt="" style="width: 40px;">
                    <img class="automatic" id="automatic2" src="image/execution3.png" alt=""
                        style="width: 40px; display: none;">
                </div>
            </div>
        </div>
        <div class="completion-message" id="completion-message" style="display: none;">
            üéâ B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc! üéâ
            <span>Ch√∫c m·ª´ng b·∫°n v·ªõi k·∫øt qu·∫£ tuy·ªát v·ªùi!</span>
            <span class="score-display" id="score-display" style="font-weight: 900;">ƒêi·ªÉm s·ªë: 0</span>
            <span class="correct-count" id="correct-count">S·ªë c√¢u ƒë√∫ng: 0</span>
            <span class="wrong-count" id="wrong-count">S·ªë c√¢u sai: 0</span>
        </div>

        <div class="detailed-review" id="detailed-review" style="display: none;">
            <h2>K·∫øt qu·∫£ Chi Ti·∫øt</h2>
            <table class="review-data" id="review-data">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>C√¢u h·ªèi</th>
                        <th>C√¢u tr·∫£ l·ªùi</th>
                        <th>K·∫øt qu·∫£</th>
                    </tr>
                </thead>
                <tbody class="table-body" id="table-body">
                    <!-- C√°c h√†ng d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    <tr>
                        <td>1</td>
                        <td>question 1</td>
                        <td>your word</td>
                        <td>word</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- <script src="../js/app.js"></script> -->
    <script>
        // alert("Ch·ª©c nƒÉng n√†y c√≤n ƒëang trong qu√° tr√¨nh ho√†n thi·ªán!");

        var flashcards = JSON.parse(localStorage.getItem("data")) || [];
        var original = flashcards.map(element => element);





        var index = 0;
        var tudong = null;
        var socau = null;
        var saveYourAnswer = null;
        var iscore = null;
        var boolscore = null;
        document.getElementById("question-count").value = flashcards.length;

        const number = document.getElementById("number-qs");
        const mean = document.getElementById("meaning");
        const nextbtn = document.getElementById("next-button");

        const displayanswer = document.getElementById("feedback-message");

        document.getElementById("star-qs").addEventListener("change", (event) => {
            if (event.target.checked) {  // Check if the checkbox is checked
                document.getElementById("question-count").value = JSON.parse(localStorage.getItem("favouriteID")).length;
            } else {
                document.getElementById("question-count").value = flashcards.length;
            }
        });


        document.getElementById("start-button").addEventListener("click", () => {
            socau = document.getElementById("question-count").value;
            tudong = document.getElementById("tudong").checked;
            const ngaunhien = document.getElementById("option-random").checked;

            if (document.getElementById("star-qs").checked) {
                flashcards = JSON.parse(localStorage.getItem("favouriteID")) || [];
            } else flashcards = JSON.parse(localStorage.getItem("data")) || [];

            if (socau > flashcards.length || socau <= 0) {
                alert("S·ªë c√¢u kh√¥ng h·ª£p l·ªá!");
            } else {
                if (ngaunhien) flashcards = flashcards.sort(() => Math.random() - 0.5);
                if (tudong) automatic();
                saveYourAnswer = new Array(socau);
                for (let i = 0; i < socau; i++) {
                    saveYourAnswer[i] = "";
                }
                console.log(saveYourAnswer);

                iscore = new Array(socau);
                for (let i = 0; i < socau; i++) {
                    iscore[i] = false;
                }

                boolscore = new Array(socau);
                for (let i = 0; i < socau; i++) {
                    boolscore[i] = true;
                }

                begin();
                displayStar();
            }
        });

        function begin() {
            document.getElementById("settings-container").style.display = "none";
            document.getElementById("quiz-container").style.display = "block";
            display(flashcards[index].question, flashcards[index].answer);
            check(flashcards[index].question);
            document.getElementById("save-word").style.display = "block";

        }


        function display(word, meaning) {
            number.textContent = `question ${index + 1}`;
            if (document.getElementById("dinhnghia").checked) mean.textContent = meaning;
            else {
                mean.innerHTML = `<h3 class="display-question" id="loudspeakerQuestion"><img src="./image/audio-guide.png" alt="" style="width: 100px;"></h3>`;
                speak(word);
                const loudspeakerQuestion = document.getElementById("loudspeakerQuestion");
                loudspeakerQuestion.onclick = function () {
                    speak(word);
                }
            }



            document.getElementById("box").innerHTML = "";
            const div = document.createElement("div");
            div.className = "fill-blank-box";
            for (let i = 0; i < word.length; i++) {
                const input = document.createElement("div");
                input.innerHTML = `<input type="text" maxlength="1">`;
                if (word[i].trim().length === 0) {
                    input.innerHTML = `&nbsp;&nbsp;`;
                }
                div.appendChild(input);
            }
            document.getElementById("box").appendChild(div);
        }
        function removeWhitespace(inputString) {
            // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c replace v·ªõi bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ lo·∫°i b·ªè kho·∫£ng tr·∫Øng
            return inputString.replace(/\s+/g, '');
        }
        function splitByPattern(string1, string2) {
            // T√°ch chu·ªói string1 th√†nh m·∫£ng d·ª±a tr√™n kho·∫£ng tr·∫Øng
            const string1Parts = string1.split(" ");

            // Bi·∫øn gi·ªØ k·∫øt qu·∫£
            let result = [];
            let currentIndex = 0;

            // L·∫∑p qua t·ª´ng ph·∫ßn t·ª≠ c·ªßa string1Parts
            for (let part of string1Parts) {
                // C·∫Øt chu·ªói string2 d·ª±a tr√™n ƒë·ªô d√†i c·ªßa t·ª´ng ph·∫ßn t·ª≠ trong string1Parts
                result.push(string2.slice(currentIndex, currentIndex + part.length));
                // C·∫≠p nh·∫≠t ch·ªâ s·ªë hi·ªán t·∫°i
                currentIndex += part.length;
            }

            // Tr·∫£ v·ªÅ chu·ªói ƒë√£ t√°ch, n·ªëi b·∫±ng kho·∫£ng tr·∫Øng
            return result.join(" ");
        }
        function check(word) {
            const inputs = document.querySelectorAll("#box input");
            inputs[0].focus();
            var ischeck = true;
            var yourAnswer = "";
            originalword = word;
            word = removeWhitespace(word);
            console.log(originalword);
            Array.from(inputs).forEach((element, index) => {
                element.addEventListener('keydown', (event) => {
                    if (element.value !== "") {
                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                        setTimeout(() => {
                            if (index === inputs.length - 2) {
                                Array.from(inputs).forEach((element, index) => {
                                    yourAnswer += element.value;
                                    element.disabled = true;
                                    if (element.value.toLowerCase() !== word[index].toLowerCase()) {
                                        element.style.color = "red";
                                        ischeck = false;
                                    }
                                    else element.style.color = "green";
                                });
                                saveAnswer(splitByPattern(originalword, yourAnswer));
                                // alert(yourAnswer);
                                score(ischeck);
                                // if (ischeck) playAudio("./audio/right.mp3");
                                // else playAudio("./audio/wrong.mp3");
                                if (tudong && ischeck) {
                                    setTimeout(() => {
                                        next();
                                        displayStar();
                                    }, 1000);
                                }
                            }

                        }, 100);
                    }
                });
            });
        }
        function score(value) {
            if (boolscore[index]) iscore[index] = value;
            boolscore[index] = false;
        }
        function saveAnswer(yourAnswer) {
            if (saveYourAnswer[index].length > 0) saveYourAnswer[index] += " - " + yourAnswer;
            else saveYourAnswer[index] = yourAnswer;
        }
        function next() {
            if (index < socau - 1) {
                index++;
                displayanswer.style.visibility = "hidden";
                display(flashcards[index].question, flashcards[index].answer);
                check(flashcards[index].question);
            } else {
                //playAudio("./audio/finish.mp3");
                document.getElementById("quiz-container").style.display = "none";
                document.getElementById("completion-message").style.display = "block";
                document.getElementById("detailed-review").style.display = "block";
                document.getElementById("save-word").style.display = "none";
                displayMark();
                // document.getElementById("correct-count").textContent += sum(score);
                console.log(iscore);
                var right = 0;
                for (let i = 0; i < socau; i++) {
                    if (iscore[i]) right++;
                }
                // console.log(right);

                document.getElementById("score-display").textContent = "ƒêi·ªÉm s·ªë: " + (parseFloat(((socau - (socau - right)) / socau) * 10)).toFixed(1);
                document.getElementById("correct-count").textContent = "S·ªë c√¢u ƒë√∫ng: " + right;
                document.getElementById("wrong-count").textContent = "S·ªë c√¢u sai: " + (socau - right);


                const userKey = localStorage.getItem("current-key-46587") + "fillBlank";
                let userData = JSON.parse(localStorage.getItem(userKey)) || {totalScore: 0, attempts: 0, averageScore: 0}; // object ch·ª©a th√¥ng tin to√†n b·ªô user


                // T√≠nh ƒëi·ªÉm cho l·∫ßn l√†m b√†i hi·ªán t·∫°i
                const currentScore = parseFloat(((right / socau) * 10).toFixed(1));

                // C·∫≠p nh·∫≠t d·ªØ li·ªáu
                userData.totalScore += currentScore;
                userData.attempts += 1;
                userData.averageScore = parseFloat(
                    (userData.totalScore / userData.attempts).toFixed(1)
                );

                // L∆∞u l·∫°i v√†o localStorage
                localStorage.setItem(userKey, JSON.stringify(userData));

                // Th√¥ng b√°o ƒëi·ªÉm trung b√¨nh
                alert("ƒêi·ªÉm trung b√¨nh: " + userData.averageScore);


            }
        }
        function nextBtn() {
            nextbtn.addEventListener("click", () => {
                next();
                displayStar();
            })
        }
        if (!tudong) nextBtn();

        document.getElementById("answer-button").addEventListener("click", () => {
            displayanswer.textContent = flashcards[index].question;
            displayanswer.style.visibility = "visible";
            score(false);
        });

        document.getElementById("again-button").addEventListener("click", () => {
            display(flashcards[index].question, flashcards[index].answer);
            check(flashcards[index].question);
        });

        document.getElementById("automatic1").addEventListener("click", () => {
            automatic();
        });
        document.getElementById("automatic2").addEventListener("click", () => {
            tudong = false;
            document.querySelector("#automatic2").style.display = "none";
            document.querySelector("#automatic1").style.display = "inline";
        });
        function automatic() {
            tudong = true;
            document.querySelector("#automatic1").style.display = "none";
            document.querySelector("#automatic2").style.display = "inline";
        }

        function displayMark() {
            document.getElementById("table-body").innerHTML = "";
            for (let i = 0; i < socau; i++) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    
                        <td>${i + 1}</td>
                        <td>${flashcards[i].question}</td>
                        <td>${saveYourAnswer[i]}</td>
                        <td>${flashcards[i].answer}</td>
                    
                `;
                document.getElementById("table-body").appendChild(tr);
            }
        }

        document.getElementById("save-word").addEventListener("click", () => {
            // alert(document.querySelector("#save-word img").src);
            if (document.querySelector("#save-word img").src.endsWith("star.png")) {
                document.querySelector("#save-word img").src = "./image/star (1).png";
                flashcards[index].save = true;
                // alert(original[index].question === flashcards[index].question);
                saveFavourite(true);
            } else {
                document.querySelector("#save-word img").src = "./image/star.png";
                flashcards[index].save = false;
                saveFavourite(false);

            }
        });
        function saveFavourite(value) {
            if (original[index].question === flashcards[index].question) {
                original[index].save = value;
            } else {
                for (let i = 0; i < original.length; i++) {
                    if (original[i].question === flashcards[index].question) {
                        original[i].save = value;
                        break;
                    }
                }
            }
            localStorage.setItem("data", JSON.stringify(original));
            AddFavourite();
        }
        function displayStar() {
            if (flashcards[index].save) {
                document.querySelector("#save-word img").src = "./image/star (1).png";
            } else document.querySelector("#save-word img").src = "./image/star.png";
        }

        function AddFavourite() {
            // var favouriteList = JSON.parse(localStorage.getItem("favouriteID")) || [];
            var favouriteList = [];
            for (let i = 0; i < original.length; i++) {
                if (original[i].save) favouriteList.push(original[i]);
            }
            localStorage.setItem("favouriteID", JSON.stringify(favouriteList));
            console.log(favouriteList);

        }
        function speak(inputText) {
            // const inputText = document.getElementById("text-input").value; // L·∫•y gi√° tr·ªã vƒÉn b·∫£n t·ª´ √¥ input
            const utterance = new SpeechSynthesisUtterance(inputText); // T·∫°o ƒë·ªëi t∆∞·ª£ng ch·ª©a vƒÉn b·∫£n c·∫ßn ƒë·ªçc
            window.speechSynthesis.speak(utterance); // ƒê·ªçc vƒÉn b·∫£n
        }



        // H√†m ph√°t √¢m thanh
        function playAudio(status) {
            const audio = new Audio(status);
            audio.play();
        }


    </script>
</body>

</html>